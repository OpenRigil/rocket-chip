#include "mmio.h"

#define MMM_STATUS  0x2000
#define MMM_CONTROL 0x2004
#define MMM_PPRIME  0x2008
#define MMM_P       0x200C
#define MMM_A       0x2010
#define MMM_B       0x2014
#define MMM_IW      0x2018
#define MMM_IW2     0x201C
#define MMM_OUT     0x2020
#define BLOCK          128  // 4096/32
volatile uint64_t tohost;
volatile uint64_t fromhost;

static void do_tohost(uint64_t tohost_value)
{
  while (tohost)
    fromhost = 0;
  tohost = tohost_value;
}

static void cputchar(int x)
{
  do_tohost(0x0101000000000000 | (unsigned char)x);
}

static void cputstring(const char* s)
{
  while (*s)
    cputchar(*s++);
}

static void terminate(int code)
{
  do_tohost(code);
  while (1);
}

uint32_t a[BLOCK] = {0x6db36862,0x2a88fcdf,0x5e4ed822,0xa8f496e6,0xaba5ed30,0xe91a782f,0x392113f1,0x1ba0bec6,0xa785c665,0x1e7dba18,0x96ccb68,0x98b67d7,0x2326ea79,0xf87014fc,0x17aa8df4,0x3460360a,0xe8129974,0x9eb107d9,0xa499b27b,0xf27b66b2,0xaf10a1a4,0x1a616a14,0x3e730e4f,0x901eabac,0x65ba9e8b,0x3f2022e1,0x3b016e13,0x4af85063,0xdbf18612,0x8a6d7bca,0x45be437c,0x8ebd9037,0xbe6f1922,0xe9b4a271,0x66f3f02a,0xb7cb5f05,0xc5e66c1d,0x728175f,0x5967e7e7,0x7602e8dc,0x53dd7bb1,0x1348a9e6,0x8624a665,0x2308eade,0xcda1fd63,0xb6abf58,0x84b4fb1e,0xec080fc3,0x9e70f50,0x59252dd9,0x437d060b,0xe5b270b7,0x83db43c3,0xaf2d95e9,0xa31b054b,0x68c36a53,0x139d86be,0xa019b949,0xbf5d827f,0xc9add346,0x4e0f2974,0x87e66828,0x4bd3a624,0xf8f1ccc6,0x149d90f9,0xf0b6d5a3,0x899f30e0,0x4fecc22f,0xdb0d6f1a,0x284e4f83,0xfdb2903e,0x3c0e006c,0xaca14dd6,0x31dc59dd,0x5b606fa6,0x8d2cc705,0xae237772,0x3432ce23,0xc20d363e,0xea454185,0xc4be5d49,0xf72f1a85,0xca47a747,0xbfdc2ddc,0x6ea764e1,0x15d2b79c,0xe2658ce0,0x6b0ea2f,0xc9a1dbf9,0x217774c,0x97d49538,0x1b2ea6fc,0x59b03f51,0xede8dfc9,0xc785a0a7,0x270fa087,0x768243b7,0xdc6926b9,0xc22e4efb,0x6f6de9d4,0xc9691833,0x7ece22a8,0x884fead0,0x27f055bb,0xdb4f9e7f,0x9db991d5,0x849725b2,0x68eedfc,0xf550fed4,0xdde640fd,0x3eded8de,0x199c04d2,0x6af18ff5,0x89c9f827,0xf69da966,0xe55ab976,0xf0819b0f,0xec62684d,0x2dc70416,0xf1968276,0x2c4affa2,0xb099af54,0x825ae1b8,0xf9b6d544,0xca8db1d2,0xc9855a39,0x2b5798d2,0x1187a3e0,};
uint32_t b[BLOCK] = {0xa2bb10c9,0xb5a7718b,0xac881eac,0xbfc98eff,0x5ed5b442,0x544e0a83,0xa0cf0caf,0xc1fa84ee,0xf9ef468d,0x8d3c7a83,0xc7c56f1f,0xf41c1753,0xe93e56dd,0xd0b9b1d8,0x139109df,0x7e7c1f6,0x47fe4652,0xb43c940,0xa8fbea33,0x9a874ab3,0x3b5da9c5,0xf303cad0,0xa93da49d,0xe7965bd9,0xd93ab991,0x5118e54f,0x43a2c395,0x7a2e3ca,0xd9102ed2,0x88cd664d,0x54515cf2,0x2e2b5c1c,0x213b9c93,0x5b09ef25,0xbe2096d9,0x9d0f95fa,0xb14deeef,0x2f2deb74,0x3a7d017,0x4af8f2ed,0x36244695,0xb663d731,0x4531e8fa,0x980fda30,0xba6b840e,0x5c467b6e,0xe38e50f,0x974ac2b2,0xa9d6f56f,0x3cabb5fe,0x604f9702,0xdaf82f05,0x68e33836,0x134de59b,0x66dcaa71,0xb0c86ff9,0xe283f51b,0x86fc0dda,0xabcfeac2,0xd704aa57,0xec2ab0ec,0xc8fe917,0x1b5e0b3e,0x51e41636,0x90492eb3,0xad64b61f,0xb957956c,0x72b3398f,0x54f78060,0xa31bb0a5,0x520fe62c,0xa0bbf3b9,0xf652dd5a,0xb19ae2ed,0x6910f5b4,0x89d1d246,0x17296ca7,0x56efd2b0,0xdfde4227,0xb43a94a7,0x80606def,0x9e8c666c,0x28977085,0x344b43c8,0x2bc7a553,0x6fe36c1e,0x87f4228f,0xaf1989cf,0x2f31c968,0x61a0be1e,0xa6fca728,0xfe983b5e,0x1f8e2f19,0xb6a900f8,0x6ad8f6bb,0xc723c2d6,0xff59370e,0xdd565aec,0x1a1c517f,0x72b86d7c,0x626bdaf9,0x3979ed,0x394b6384,0xf2ba682c,0x87255cf2,0xc1648d1b,0xf9d0c0c6,0xfac26e87,0x54a74477,0xd4d2945f,0xb45b1ed0,0xf74df7bd,0xf8715353,0xd7f51555,0x5d6b1444,0x5aff00f8,0xbebd8b27,0x4000e6db,0x177551a9,0x5599f10f,0xa6b7d58d,0xc4fe31b5,0x79a49c2e,0x1d221320,0x7b1bf84b,0x89384e3c,0x91026122,0xc1f1bc1d,};
uint32_t p[BLOCK] = {0xfbcba285,0xc04c2b62,0x5b0b08e6,0x740344c7,0x1a5f1291,0x34d43100,0xa5897006,0xa8415ee5,0x5c18c2ef,0x3b5470c9,0xb89c2d96,0x466aaff1,0xb6dd9efa,0x4bbc7749,0x93fc38b3,0x3f00a629,0xcbb288b9,0x1a52a694,0xbe5dc96b,0xadfd2fe8,0x57eda394,0x9b5f4b79,0xa94fd37e,0xea7d5559,0x753bd1a9,0x81dee079,0x738afe08,0x845c9438,0x7ab43358,0xfe88d10c,0x81cbfc76,0xeb3fd86,0x64e17887,0x5dd87a8f,0x97cdb6df,0xb7701af,0xb900b51b,0xd89bd6ba,0x8ebae71c,0x91b1c1e7,0xc73b0db,0x1df4e5e2,0xd94a87c7,0xcb1f57bb,0xbd7e85ae,0x753cb359,0xb51541e3,0xdddd9896,0x90b18ee9,0xd41dd10,0x7aef5496,0x5ff1faf3,0x9549249c,0xab30d7cf,0x65325a92,0x471d9f61,0x7ad1212f,0x4fe87034,0x793d7a6b,0x1dcd09d8,0xe2feb60b,0xd2db01e0,0xf5d0ea7f,0x22427759,0x1a09e701,0x710ff53a,0x56f45224,0xb1e3f439,0xac3bffdd,0x4ade78ee,0x962d20a5,0x1f4c6fa4,0x447613e6,0x2ea29d8f,0xd6d62769,0xf82d88a1,0xb3402540,0x756503de,0xd2077418,0xc8d55e1,0xf16b3547,0xc77f073,0xc58be3db,0xb4157073,0xa2947f44,0x69e4dae5,0x169e76cf,0x9412a3fc,0x80b30795,0xede43b23,0x7a61a2e5,0xb36be6f,0x1a06033a,0x32324b08,0xb7221a5b,0x12ab4ee3,0xe94ce4d9,0xcf079e3c,0x3dee16c0,0x67cb38c,0x78680c58,0x915b3705,0x6db65084,0x3c3a0a94,0x123c0f02,0xa81ffcc9,0xa3e59a09,0x324bbd77,0x501f4b30,0xd3f8f4c3,0x3cc0659c,0x2fc2f7d4,0x276de326,0xbb0dca2f,0x814f04a4,0xf4e78db7,0x686467f,0xb31942ff,0xf027af84,0x55580ff5,0xe9fd5565,0x873d4573,0xa8003491,0x484fbc9d,0x34bf34bd,0xb44e6d55,0xc68c5eb5,0xc99650a7,};
uint32_t ref[BLOCK] = {0x435c1475,0xe2dd0fba,0x8b026dc9,0x7cae2839,0xea70c65b,0xe8a998a6,0xdf40a85,0xac47c784,0xb86cf72a,0xf4579c0b,0x1abcb3fd,0x6019eddf,0x59ad7f67,0xe3f96867,0x8b072ad0,0x862fe071,0xbab73f86,0xca3690a8,0x6e16456a,0xb941bbca,0x37af8fb,0x154a8d2e,0x7d1d612,0x3180f4db,0x9da7e1ce,0x4b604f68,0x9d34c7a7,0xbfd9426e,0x34edbfeb,0x9cf1bd0c,0x22c0ced5,0xcaed3e9a,0xb01d84d8,0x51bca712,0xecb53cc3,0x74f21b0b,0x31a5ce2c,0xc804c08b,0xa0bd85b1,0x4123383c,0xd5f69a31,0x831076aa,0xc5634dfb,0xdc4cd872,0x6e7dac0e,0x387b5afe,0xd583b41b,0xe0b5fc8b,0xef8af441,0x9be5094b,0x31840b7e,0x62d6ed97,0x6aa0d917,0x49af11ba,0xbf05fa33,0x75d007b8,0x5ccf3e12,0x28dcfab2,0xf9c5ec92,0x285e70d5,0xdb787abd,0x14127a7a,0x25632d8a,0xcdb3fcaf,0x9fb8c3fa,0x32de6ff1,0x65908cb4,0xbd04b772,0xfdac106,0x9d7e701c,0xbc01fb79,0x5db7a0ef,0x8373fea5,0xbdce2c69,0x4d1a7435,0x5a558e04,0x432daf00,0x54d8eaaa,0xa4aee13,0x521e036b,0x6a8973f,0x83e14b5f,0xd522d667,0x8f6f67ca,0x1c7dceda,0xe87c0e3,0x276734f9,0x9b1dac0c,0x1155404b,0xf3cb4322,0xdf40f110,0x1bc09862,0x9e2a99cf,0x1a15af75,0x813e766d,0x696ab95,0x95e7d393,0x458bec56,0x1590007,0x4d38e621,0x3028b810,0x878c5524,0x44ec0dee,0xb5dfdc32,0x9a099a3b,0xc872b881,0xefd33fcf,0x801b89a7,0x6ca7f52d,0xda3a365d,0x8c9579f4,0x435571c2,0x50b7cf3a,0x6a0f7e2c,0xb3abe9f5,0x25157d8e,0x3e3db26f,0x42ff848e,0xe4682c1a,0xcdcefe4f,0xa771b85f,0xad0d64d0,0x54e13230,0x98efcccc,0x832284d7,0xa421e970,0xcca91c2e,0xa762c2c0,};


void main(void)
{
  uint32_t result;
  uint32_t input_width1;
  uint32_t input_width2;

  input_width1 = 255, input_width2 = 15;

  volatile int *m = MMM_OUT;
  // wait for peripheral to be ready
  //while ((reg_read8(GCD_STATUS) & 0x2) == 0) ;

  reg_write32(MMM_IW, input_width1);
  reg_write32(MMM_IW2, input_width2);
  reg_write8(MMM_PPRIME, 1);
  reg_write32(MMM_P, p[0]);
  reg_write32(MMM_A, a[0]);
  reg_write32(MMM_B, b[0]);
  // send ready signal
  reg_write8(MMM_CONTROL, 2);
  for(uint32_t i = 1; i < BLOCK; i++) 
  {
    reg_write32(MMM_P, p[i]);
    reg_write32(MMM_A, a[i]);
    reg_write32(MMM_B, b[i]);
  }

  // wait for peripheral to complete
  while ((reg_read8(MMM_STATUS) & 0x1) == 0) ;
  for(uint32_t i = 0; i < BLOCK; i++) 
  {
    result = reg_read32(m);
    if (result != ref[i]) {
      terminate(841);
    }
  }

  terminate(1);
}
